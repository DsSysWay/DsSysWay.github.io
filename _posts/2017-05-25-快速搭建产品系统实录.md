---
layout: post
title: "产品后台搭建总结."
categories:
-  系统设计
tags:
-  后台系统 



---
上次写博文应该是年初的时候，眨眼间2017已经过去半年了。 这半年来
换了新的游戏项目，996周末还要兼职搞一个外包产品的开发。身心俱疲。
好在缓过来了。不管是游戏项目本身还是做产品本身，都给自己带来了
许多锻炼和思考。最近空闲下来，把之前搭建外包产品系统经历的东西
和考虑点整理出来。方便以后做的时候有历史可参照，也方便其他人
参考交流，少踩点坑。




---
我接手的项目需要用到群聊功能，消息推送，提醒功能。以及常规的请求应答
接口。预估目标用户量不超过10万。需要支持管理端，Android，iOS，以及网页端.
开发时间在半年内。账号体系方面需要支持微信，微博，qq主流社交账号直接登录
还要支持扫一扫登录。支持短信验证改密。由于项目涉及到金钱相关的操作，因此
安全方面也要重点考核.
下面来聊聊面对这样一个产品系统构建过程中的一些心得体会。


---

### 善用服务

麻雀虽小五脏俱全。大多数人接触到的外包系统用户量几乎很少过百万的。由于涉及
金钱余额操作，因此安全性摆在第一位。此外，稳定性也很重要。我做产品一贯坚持
的原则是先可提供稳定持续的服务，可扩展性和性能摆在其他位置。由于时间紧，开发
效率也很重要。

+ 语言框架方面选择了php和ThinkPHP，适合扩展，尤其是ThinkPHP
作者后来开发的OnThink 基于该内容框架二次开发管理端速度非常快。

基础服务，能用服务组件则尽量使用，避免花费时间在造轮子上

+ 群聊功能，推送功能使用了leancloud的群聊推送功能。
leancloud还有完备的账号体系，账号还支持使用第三方登录创建账户，
支持用户名和密码登录，支持短信验证码登录，甚至账号本身还支持ACL权限控制
所以app，网页的账号体系全部都交给了leancloud。

+ 图床服务直接使用七牛云存储，申请下来非常简单。 图片上传是在管理端上传的。
OneThink的图片上传服务就封装了七牛的图片上传，只要稍微修改下配置
就能实现管理端直接上传图片到七牛云存储了，非常方便

+ 服务器直接使用了阿里云的ECS服务器，在上面还可以购买云数据库，阿里云自动
帮你做了binlog的增量备份以及一日一次的总体备份。对于数据库还可以一键申请
从服务器，业务完全不需要关心读写分离，阿里云的agent会自动解析sql，根据sql
是读操作还是写操作将数据库请求分发到不同的db实例去


---

### 善用工具

好的工具可以极大的提高团队协作效率和开发效率。
笔者的开发团队分布在北上广，大家工作基本都是远程沟通。因此及需要好的协作工具

+ 代码托管我们选择了 [coding](https://coding.net/)
这个平台。 在上面还可以拟定计划和里程碑
定期的梳理进度等。但是我们用的最多的还是coding提供的git代码托管功能。
以及文档托管。

+ 协议接口文档我们使用了有道云笔记提供的markdown文档模式。采用[markdown](http://wowubuntu.com/markdown/#list) 语法编辑
之后可以将接口返回的json格式非常简洁明了的展现出来。对于初期接口还没准备好
又要定义复杂的json结构类型。可以先使用[json在线编辑器](http://www.bejson.com/jsoneditoronline/)
编辑json格式再使用[json在线格式化](http://www.bejson.com/)
输出易于查看的json数据样式.由于一开始就定义好协议，前后台都可以
同时进行协作。而且因为直接沉淀到文档，减少了很多沟通成本

+ 开发工具类就很多了，web开发中用的最爽的是postman，可以直接
模拟发送http post 请求包，随时随地观察回包情况.当然工具不止别人
封装好的工具。对于后台开发来说尤其是使用php开发。善于使用日志
输出，捕捉上下文也可以提高开发定位问题的效率.由于平常经常需要
给数据库灌入假数据进行测试，利用手工录入费时费力。这种重复劳动
也可以快速写个录入脚本自动录入数据。每一个优秀高效的程序员，也必定
是个善于偷懒的程序员.
另外开发php推荐使用phpstorm IDE，上手了开发效率还是可以的。


+ 另外设计子系统实现方案的时候。最好根据业务需求抽象出数据的不同状态。
画出完备的状态流转图和协议交互时序图，也就是UML序列图
凡事想清楚了和需求方反复确认之后再动手。一般甲方在提需求的时候
通常只考虑正常情况，异常情况常常没有提及或者根本没考虑到。
在开发阶段如果再把异常分支考虑进来，往往导致返工，效率低下
对于UML序列图强烈推荐使用Astah Professional.序列图里头可以手写
接口，开发的时候直接参照画的序列图开发，避免自己犯错.



---

### 避免过度设计

我们最开始采用的是LAMP来搭建系统。有一个相对比较复杂的数据
检索接口需要扫表构建数据集给前台展示。因此当时还引入了redis来
cache 检索数据，再定期过期淘汰。事后证明这么做只是给自己添堵。
维护缓存数据是个不小的开发工作。而且容易带来数据一致性问题。
后面及时砍掉了缓存这块的逻辑，改为直接操作db。在只有几万用户
的体量下，直接操作mysql是完全可以满足业务需求的。如果满足不了
，就要看看是否是自己实现的有问题了



---

### 踩过的坑

下面来聊一聊开发过程中遇到的一些其他人可能也会遇到的问题以及处理方法。

1. https 设置问题  

站点和app需要设置https，是基于下面几点考虑：

* app和站点使用https加密传输数据，防止中间数据被窃取或者篡改
* 苹果提审要求，不支持https会导致提审失败
* 有https证书的站点会显示小绿锁，给用户安全提示。特别是对于涉及
有金额交易的站点，小绿锁的存在能够给用户一定的心理安慰

笔者站点使用的https是在goaddy上申请的。申请证书的过程需要需要上传
服务器的SSL csr文件，填写域名，并且通过goaddy提供的方式验证对于域名的所有权，
成功之后会得到三个文件，两个crt和一个key文件.站点的https配置可以参照以下
文章操作[https 配置](http://www.cnblogs.com/chjbbs/p/5748369.html) 
配置完后可以使用[SSL Checker](https://www.sslshopper.com/ssl-checker.html)
检查配置是否生效。之前我配置的过程中忘记添加根证书了。结果小绿锁
显示失败. 把其中一个crt文件A追加到另一个crt文件B中，再在配置里引用下B就解决了。

另外web站点在进入某些页面的时候，还遇到了https小绿锁突然失效的情况。
这是由于站点引用了一些非https的资源导致小绿锁显示失败。
这个问题在某些站点也能看到，例如斗鱼直播的某些页面.
这种情况并非只是不显示小绿锁, 当站点使用https的时候，如果引用了非https的资源，这样的页面分享到
qq，微信都会直接白屏，iOS会提示证书非安全。分享的体验会受到影响

针对上述这种情况。可以将web站点使用的js和css静态资源全部托管到七牛云存储上
配置CDN动态加速域名，将域名配置为https的。即使有老的资源已经上传，配置完https自
定义域名后，七牛原有上传的图片链接也会自动转换为自定义域名.
七牛巧妙的使用了CNAME的机制，将用户提供的自定义域名CNAME到自己分配给用户的图片域名
上面去。对于自定义域名的证书，七牛也提供了证书申请平台，申请完后证书自动关联
对应域名.弄起来非常方便。等到所有的资源都切成https之后，上述的小绿锁问题
和分享失败的问题都能够解决了。

2.开发过程中还遇到使用第三方登录leancloud账号系统遇到的问题。

相信很多项目在开发过程中，都要支持qq，微信，微博三大主流平台的
登录。网页上要支持微信，手机qq，微博客户端直接扫码登录。
手机上同样要支持呼起微信，qq，微博客户端直接授权登录。
这些leancloud都有很好的支持。简单说来就是授权给应用之后，应用
可以拿到用户的openid和access_token. 对于leancloud 来说，这些就是
用户名和密码了。通过使用openid检索leancloud的_User表，再验证access_token
是否有效。对的上就能返回用户的唯一ID和会话token。
我们的项目也不例外。但是后来发现，在申请微信和qq的时候，同一个开发者账号
申请到的web和移动端的appid和appkey是不一样的。

对于同一个产品的不同端（Android，iOS，web）微信和qq都认为是不同的应用。
所以通过不同端登录上来的用户拿到的openid都不一样，这就导致了对于同一个应用
。用户通过同一个微信号或者qq号，通过网页授权登录以及移动端授权登录登入的是不同
的号。这个体验肯定是没法接受的。正常应该是通过同一个账号，不管通过什么终端登入
都是同一个账号。


针对这种情况，微信和qq提供了一个UnionID的机制。也就是对于同一个申请账号申请的不
同应用。这些应用如果是同一个微信或者qq登入的，那么通过微信或者qq接口可以得到同一
个UnionID.可以在leancloud的User表里新建三个列，QQUid，WxUid.

举个例子:
假设用户最开始通过qq移动端登录应用。应用后台拿着授权得到的openid和token去查询
leancloud。如果没有leancloud此时会新建一个用户账号。应用同步qq用户的用户名和
头像信息。并且设置好UnionID.下次用户通过网页登录，只要先通过授权拿到的UnionID去
查询User表，查到之后可以直接通过leancloud返回的数据拿到qq移动端登录的时候用的
openid和token。拿着这些授权信息直接登录leancloud即可。但是这种方式需要设置
leancloud不对access_token进行有效性验证。否则qq移动端长久不登录应用。
leancloud上的access_token就长久得不到更新，一旦超过有效期后，检查不通过，通过
UnionID这种方式网页端就无法登录上了。这个是官方提供的做法，当然是以损失一定的
安全性为前提的。

眼尖的人也许发现我并没有提到微博。这是因为微博通过同一个开发者账号申请的不同应用
最后拿到的Uid是一致的，所以不存在上述微信和qq的问题


3. IPV6问题。
苹果爸爸提审要求服务器支持ipv6访问。而国内产商因为安全等问题，是不支持
服务器ipv6设置得。因此需要自己打开，可以通过打ipv6隧道的方式来处理。具体不
赘述了。可以参照以下这篇文章：
[阿里云服务器如何设置IPV6通过appstore的审核](http://www.cnblogs.com/vijayfly/p/6612771.html)

---
当然使用服务总会有坑的。leancloud用户系统的设计根本没有考虑到多端登录态的问题
。如果项目要支持网页端用户登录态和Android，iOS各自的token有效期，对不起，
leancloud不支持，每一个账号只有一个sessionToken。要基于sessionToken设计不同端的
过期机制是不可能的。而且leancloud的sessionToken是不会过期的，需要业务自己去刷新
。基于leancloud的用户体系，只要sessionToken一泄露，基本上可以拿到用户的所有信息
。而且可以无障碍登录Android,iOS，网页端.业务侧需要针对sessionToken做一些过期保护
机制很难，因为一端设置过期刷新了sessionToken，会导致其他已经登录过的客户端提示会
话过期，需要重新登录，这种体验位于产品，对于用户来说是无法接受的。

另外leancloud 为了支持用户名和密码登录，他的User表里name用户名是全局唯一的。一旦使用name
来作为用户名称，并且第三方用户名称已经被占用了，leancloud会同步失败(头像，用户名)并且给你
生成一串随机值作为用户名称。因此做第三方登录千万不要用name这个字段作为用户名字。
最好在leancloud的User表里再添加WxName，QQName这些。通过哪个平台登录的就用哪个平
台的name。但是这样子客户端就得关心是哪个平台登录的了.而且leancloud本身提供了一些
SDK。如果SDK上使用了name来显示用户名称，改起来就很麻烦了。


---

### 服务器安全

最后来聊一聊服务器安全部署的问题

第一次在测试机上搭建redis的时候为了方便直接root启用了redis服务。
而且没有设置密码。后面发现服务器被入侵了。被一个法国人hack整成了挖矿机。
无奈测试机CPU计算能力有限。挖矿机跑起来我们连SSH都登不上去。这才发现问题。

后面自己去网上搜索了入侵原理，仿照着入侵下别人。结果真的弄到了服务器
root的登录权限。这其中有北京的创业公司的服务器集群，也有一些中型企业的
IBM机子，连百度的机子也黑了进去。当然权当学习。黑过的机子都mail给别人
让别人修补了漏洞了。这里推荐一个扫描系统，可以扫出有redis漏洞的站点，看下
自己是否在单子上.没错，他就是[钟馗之眼](https://www.zoomeye.org/)
。之后部署的时候就特别小心了。在这里罗列下一些自己认为比较重要的点：

* 业务服务组件进程最好源码编译，运行在非root用户权限下，并且对运行用户权限
做下严格限定
* SSH端口最好开在非22端口上
* 非必要服务可以直接关闭掉
* 关闭SQL一些操作权限，类似于drop表删表数据或者删数据库的。
* 限制root直接ssh登录
* 对于redis服务最好不要开在6379端口，并且设置redis密码。
* 严格校验是否有sql注入
* 另外要多关注下乌云提供的组件漏洞，定时的修复漏洞。
* 缩减history操作记录

更详细的可以参照阿里云的[安全配置](https://yq.aliyun.com/articles/47328?spm=5176.100240.searchblog.8.4Zxap4)。

---

### 服务可用

最后再来聊聊服务的可用性保障。对于业务服务，为了避免单点。业务服务器最好
有两台服务器，通过nginx或者其他负载组件实现业务服务。这种并非是说用户量少就不需
要了。有时候进行系统升级或者为了查问题。可以先隔离出一台来定位处理问题。放少量请
求进来。另一台正常提供外网服务。如果只是单台提供服务，挂了可用性就很难保证了。
数据层使用阿里云提供的服务。阿里云提供的云RDS支持配置从服务器实现读写分离和一主
多从。在数据层做主从配置也是很有必要的。阿里云自动帮你做一天一个全备份和每分钟
binlog增量备份。这些都是服务可用性的一些保障措施。而且有一点做得挺好，自动帮你做
读写分离，业务不需要关心，他们搞了个agent自动识别sql是读写操作进行基于sql的分发
。当然服务可用也离不开高效率的告警机制，大厂有立体监控体系，自动监控服务器通用指
标，也有基于接口的监控，一旦出问题会第一时间发短信进行预警。作为外包产品要享受到
这种业务级别的监控还是有点奢侈的。我很看好leancloud，七牛这种服务化提供商。他们
的出现能够缩减产品开发的成本，但是还是有一些服务空白需要填补。相信未来，我们能够
更加高效率的专注业务，基础研发支持的组件也会越来越丰富。这块也是一块亟待补足的市
场。如果没人做的话以后自己也是可以拿来作为一份事业来做的

说了这么多，感觉还是说的不够深入和直白。有什么技术问题欢迎加微信交流讨论。
![微信](http://7xq3xt.com1.z0.glb.clouddn.com/IMG_20170530_000417.png)






























